# Perl言語
以下、Perlを勉強するために、環境構築として、Perlのインストールを実施する。  
`perlbrew`と言うPerlのバージョンなどを行うツールからPerlの最新版を導入し、使っていくことにする。  

以下、実際のインストール作業(書籍のP361にある)。
```terminal
$ \curl -L https://install.perlbrew.pl | bash
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   170  100   170    0     0    229      0 --:--:-- --:--:-- --:--:--   230
100  1574  100  1574    0     0   1389      0  0:00:01  0:00:01 --:--:--  7058

　　　・
　　　・
　　　・
$
```

以下、上記の管理プログラム導入後に、(現時点での)最新版のPerlをインストールする(Path通しが必要)。
```perl
```
失敗したようだ。  

以下、個別に(上記のヒント通りに)インストール再開。
```terminal
$ cd perl5/perlbrew/build/perl-5.34.0/perl-5.34.0; make install
./miniperl -Ilib make_ext.pl cpan/Archive-Tar/pm_to_blib  MAKE="/Applications/Xcode.app/Contents/Developer/usr/bin/make" LIBPERL_A=libperl.a
./miniperl -Ilib m
　　　・
　　　・
　　　・
  perl5/perlbrew/perls/perl-5.34.0/man/man1/streamzip.1
  perl5/perlbrew/perls/perl-5.34.0/man/man1/xsubpp.1
  perl5/perlbrew/perls/perl-5.34.0/man/man1/zipdetails.1
$
```
成功した？  

試しに最新版で動かす。
```terminal
$ ~/perl5/perlbrew/bin/perlbrew switch perl-5.34.0

A sub-shell is launched with perl-5.34.0 as the activated perl. Run 'exit' to finish it.

bash-3.2$ exit
exit
$
$ perl --version	←☆要は、Path通しが必要と言うことか。

This is perl 5, version 18, subversion 4 (v5.18.4) built for darwin-thread-multi-2level
(with 2 registered patches, see perl -V for more detail)

Copyright 1987-2013, Larry Wall

Perl may be copied only under the terms of either the Artistic License or the
GNU General Public License, which may be found in the Perl 5 source kit.

Complete documentation for Perl, including FAQ lists, should be found on
this system using "man perl" or "perldoc perl".  If you have access to the
Internet, point your browser at http://www.perl.org/, the Perl Home Page.

$
```
動いた。  
ただ、想定と違う実行方法になっている。  

以下、動作確認。
```terminal
$ cat ./version.pl
use v5.24;

print $^V
$ perl ./version.pl
Perl v5.24.0 required--this is only v5.18.4, stopped at ./version.pl line 1.
BEGIN failed--compilation aborted at ./version.pl line 1.
$
```
動かない。  
Path通しが必要なのか・・・。  
おかしいだろう。  
何のための**brew**か・・・そっちのPathを通せば良い？  

以下、最先端のバージョン導入。
```terminal
$ ~/perl5/perlbrew/bin/perlbrew install perl-blead
Fetching perl-blead as perl5/perlbrew/dists/blead.tar.gz
Installing perl5/perlbrew/build/blead/perl5-blead into ~/perl5/perlbrew/perls/perl-blead

This could take a while. You can run the following command on another shell to track the status:

  tail -f ~/perl5/perlbrew/build.perl-blead.log


perl-blead is successfully installed.
$ echo $?
0
$
```
これが有効だったか確認する前に、Pathを通してしまった。  

以下、Path通し後のバージョン確認。
```terminal
$ perlbrew --version
perl5/perlbrew/bin/perlbrew  - App::perlbrew/0.92
$
```

以下、インストール可能なバージョン表示。
```terminal
$ perlbrew available
 # perl
   perl-5.35.3
i  perl-5.34.0
   perl-5.32.1
   perl-5.30.3
   perl-5.28.3
   perl-5.26.3
   perl-5.24.4
   perl-5.22.4
   perl-5.20.3
   perl-5.18.4
   perl-5.16.3
   perl-5.14.4
   perl-5.12.5
   perl-5.10.1
    perl-5.8.9
    perl-5.6.2
  perl5.005_03
  perl5.004_05


 # cperl
  cperl-5.30.0
  cperl-5.30.0-RC1


$
```

以下、**perlbrew**のアップデート。
```terminal
$ perlbrew self-upgrade
Your perlbrew is up-to-date.
$
```

以下、PerlBrewにて、インストール済みのバージョン確認。
```terminal
$ perlbrew list
  perl-blead
  perl-5.34.0
$
```

以下、バージョン切り替えコマンド実施。
```terminal
$ perlbrew switch 5.34.0
$ echo $?
0
$ perl --version

This is perl 5, version 34, subversion 0 (v5.34.0) built for darwin-2level

Copyright 1987-2021, Larry Wall

Perl may be copied only under the terms of either the Artistic License or the
GNU General Public License, which may be found in the Perl 5 source kit.

Complete documentation for Perl, including FAQ lists, should be found on
this system using "man perl" or "perldoc perl".  If you have access to the
Internet, point your browser at http://www.perl.org/, the Perl Home Page.

$
```

以下、PerlBrewバージョンを終了する(既存のPerlを有効化)。
```terminal
$ perlbrew off
perlbrew is turned off.
$ perl --version

This is perl 5, version 18, subversion 4 (v5.18.4) built for darwin-thread-multi-2level
(with 2 registered patches, see perl -V for more detail)

Copyright 1987-2013, Larry Wall

Perl may be copied only under the terms of either the Artistic License or the
GNU General Public License, which may be found in the Perl 5 source kit.

Complete documentation for Perl, including FAQ lists, should be found on
this system using "man perl" or "perldoc perl".  If you have access to the
Internet, point your browser at http://www.perl.org/, the Perl Home Page.

$
```
※上記で切り替えた続きなので、バージョンが切り替わっているのは確認済み。  

以下、プログラム側でのバージョン確認。
```terminal
$ cat version.pl
use v5.24;

print $^V . "\n"
$ perl version.pl
v5.34.0
$
```
`v5.24`指定をしているのに、`v5.34.0`として動いた。  
[う〜ん](https://perldoc.jp/func/use%20VERSION)。  
Perl全く分からない。  


---
<a name="capnUpgrade"></a>
## CPANのアップグレード
アップグレードしない場合に何があるか分からないが、一応実施する。

以下、実行記録。
```terminal
$ cpan
Loading internal logger. Log::Log4perl recommended for better logging
Terminal does not support AddHistory.

To fix that, maybe try>  install Term::ReadLine::Perl


cpan shell -- CPAN exploration and modules installation (v2.28)
Enter 'h' for help.

cpan[1]> install Bundle::CPAN
Reading '/Users/asakunotomohiro/.cpan/Metadata'
  Database was generated on Sat, 15 Jan 2022 03:55:46 GMT
Fetching with HTTP::Tiny:
http://www.cpan.org/authors/id/A/AN/ANDK/Bundle-CPAN-1.863.tar.gz
　　　・
　　　・
　　　・
Installing perlbrew/perls/perl-5.34.0/man/man3/CPAN::HandleConfig.3
Installing perlbrew/perls/perl-5.34.0/bin/cpan
Installing perlbrew/perls/perl-5.34.0/bin/cpan-mirrors
Appending installation info to perlbrew/perls/perl-5.34.0/lib/5.34.0/darwin-2level/perllocal.pod
  ANDK/CPAN-2.29.tar.gz
  /usr/bin/make install  -- OK

.....................
21 subroutines in Term::ReadLine redefined

cpan shell -- CPAN exploration and modules installation (v2.28)
Enter 'h' for help.

cpan[2]> q
$
```

以下、アップグレード後のリロード。
```terminal
$ cpan
Loading internal logger. Log::Log4perl recommended for better logging

Starting with version 2.29 of the cpan shell, a new download mechanism
is the default which exclusively uses cpan.org as the host to download
from. The configuration variable pushy_https can be used to (de)select
the new mechanism. Please read more about it and make your choice
between the old and the new mechanism by running

    o conf init pushy_https

Once you have done that and stored the config variable this dialog
will disappear.

cpan shell -- CPAN exploration and modules installation (v2.29)
Enter 'h' for help.

cpan[1]> reload cpan	←☆再読み込み。
(・・・)
11 subroutines redefined

cpan[2]> q
Lockfile removed.
$
```

以下、よく分からない設定。
```terminal
$ perl -MCPAN -e shell

Starting with version 2.29 of the cpan shell, a new download mechanism
is the default which exclusively uses cpan.org as the host to download
from. The configuration variable pushy_https can be used to (de)select
the new mechanism. Please read more about it and make your choice
between the old and the new mechanism by running

    o conf init pushy_https

Once you have done that and stored the config variable this dialog
will disappear.

cpan shell -- CPAN exploration and modules installation (v2.29)
Enter 'h' for help.

cpan[1]> o conf init pushy_https
Boolean. Defaults to true. If this option is true, the cpan shell will
use https://cpan.org/ to download stuff from the CPAN. It will fall
back to http://cpan.org/ if it can't handle https for some reason
(missing modules, missing programs). Whenever it falls back to the
http protocol, it will issue a warning.

If this option is true, the option C<urllist> will be ignored.
Consequently, if you want to work with local mirrors via your own
configured list of URLs, you will have to choose no below.

 <pushy_https>
Do you want to turn the pushy_https behaviour on? [yes] 


Please remember to call 'o conf commit' to make the config permanent!

cpan[2]> o conf commit
commit: wrote '/Users/asakunotomohiro/.cpan/CPAN/MyConfig.pm'

cpan[3]> q
Lockfile removed.
$ cat /Users/asakunotomohiro/.cpan/CPAN/MyConfig.pm

$CPAN::Config = {
  'allow_installing_module_downgrades' => q[ask/no],
  'allow_installing_outdated_dists' => q[ask/no],
  'applypatch' => q[],
  'auto_commit' => q[0],
  'build_cache' => q[100],
  'build_dir' => q[/Users/asakunotomohiro/.cpan/build],
  'build_dir_reuse' => q[0],
  'build_requires_install_policy' => q[yes],
  'bzip2' => q[/usr/bin/bzip2],
  'cache_metadata' => q[1],
  'check_sigs' => q[0],
  'cleanup_after_install' => q[0],
  'colorize_output' => q[0],
  'commandnumber_in_prompt' => q[1],
  'connect_to_internet_ok' => q[1],
  'cpan_home' => q[/Users/asakunotomohiro/.cpan],
  'ftp_passive' => q[1],
  'ftp_proxy' => q[],
  'getcwd' => q[cwd],
  'gpg' => q[],
  'gzip' => q[/usr/bin/gzip],
  'halt_on_failure' => q[0],
  'histfile' => q[/Users/asakunotomohiro/.cpan/histfile],
  'histsize' => q[100],
  'http_proxy' => q[],
  'inactivity_timeout' => q[0],
  'index_expire' => q[1],
  'inhibit_startup_message' => q[0],
  'keep_source_where' => q[/Users/asakunotomohiro/.cpan/sources],
  'load_module_verbosity' => q[none],
  'make' => q[/usr/bin/make],
  'make_arg' => q[],
  'make_install_arg' => q[],
  'make_install_make_command' => q[/usr/bin/make],
  'makepl_arg' => q[],
  'mbuild_arg' => q[],
  'mbuild_install_arg' => q[],
  'mbuild_install_build_command' => q[./Build],
  'mbuildpl_arg' => q[],
  'no_proxy' => q[],
  'pager' => q[/usr/bin/less],
  'patch' => q[/usr/bin/patch],
  'perl5lib_verbosity' => q[none],
  'prefer_external_tar' => q[1],
  'prefer_installer' => q[MB],
  'prefs_dir' => q[/Users/asakunotomohiro/.cpan/prefs],
  'prerequisites_policy' => q[follow],
  'pushy_https' => q[1],
  'recommends_policy' => q[1],
  'scan_cache' => q[atstart],
  'shell' => q[/bin/bash],
  'show_unparsable_versions' => q[0],
  'show_upload_date' => q[0],
  'show_zero_versions' => q[0],
  'suggests_policy' => q[0],
  'tar' => q[/usr/bin/tar],
  'tar_verbosity' => q[none],
  'term_is_latin' => q[1],
  'term_ornaments' => q[1],
  'test_report' => q[0],
  'trust_test_report_history' => q[0],
  'unzip' => q[/usr/bin/unzip],
  'urllist' => [q[http://www.cpan.org/]],
  'use_prompt_default' => q[0],
  'use_sqlite' => q[0],
  'version_timeout' => q[15],
  'wget' => q[/usr/local/bin/wget],
  'yaml_load_code' => q[0],
  'yaml_module' => q[YAML],
};
1;
__END__
$
```


---
<a name="guiProgramPerltkuse"></a>
## GUI開発用Perl/TK利用。
GUI開発に必要な老舗のモジュールを導入して使う。  

<details><summary>CPANからのTKインストール。</summary>

CPANを使ってTkをインストールする。
```terminal
$ sudo perl -MCPAN -e shell	←☆CPAN利用ターミナルに入る(スーパーユーザでない場合利用に失敗するかもしれない)。
Terminal does not support AddHistory.

To fix that, maybe try>  install Term::ReadLine::Perl


cpan shell -- CPAN exploration and modules installation (v2.28)
Enter 'h' for help.

cpan[1]> install Tk	←☆CPANからインストール実施。
Reading '/Users/asakunotomohiro/.cpan/Metadata'
  Database was generated on Mon, 13 Dec 2021 07:17:03 GMT
Fetching with HTTP::Tiny:
http://ftp.jaist.ac.jp/pub/CPAN/authors/01mailrc.txt.gz
Reading '/Users/asakunotomohiro/.cpan/sources/authors/01mailrc.txt.gz'
............................................................................DONE
Fetching with HTTP::Tiny:
　　　・
　　　・
　　　・
Appending installation info to perlbrew/perls/perl-5.34.0/lib/5.34.0/darwin-2level/perllocal.pod
  SREZIC/Tk-804.036.tar.gz
  /usr/bin/make install  -- OK

cpan[2]> q	←☆CPANを抜け出る。
$ echo $?
0
$
```

</details>

以下、インストール済みの場所？  
```terminal
$ find . -type d -name "*Tk*"
./lib/site_perl/5.34.0/darwin-2level/auto/Tk
./lib/site_perl/5.34.0/darwin-2level/auto/Tk/pTk
./lib/site_perl/5.34.0/darwin-2level/Tk
./lib/site_perl/5.34.0/darwin-2level/Tk/pTk
$
```
ターミナル上で、`perl -E 'say "@INC"'`を実施することにより、Pathが表示される(ここに表示されるのが全てでは無いと思う)。
Tkを消す場合は、このディレクトリ4種類を消せば良い？  
逆に、手動以外での消し方は無いはず。  

Homebrewを使ったインストール
(`brew install perl-tk`)
では、そもそそも見つけられず。  

<details><summary>今回、手動インストールのみ成功した。</summary>

以下、手動インストール。
```terminal
$ ll -tr
total 551256
drwxr-xr-x@  3 asakunotomohiro  staff         96  9 13  2018 QMK Toolbox.app/
-rw-r--r--@  1 asakunotomohiro  staff    7024993  1 15 23:49 Tk-804.036.tar.gz
$ # *.tar.gzを展開。
$ ll -tr
total 551256
drwxr-xr-x@   3 asakunotomohiro  staff         96  9 13  2018 QMK Toolbox.app/
drwxr-xr-x@ 127 asakunotomohiro  staff       4064  2 14  2021 Tk-804.036/
-rw-r--r--@   1 asakunotomohiro  staff    7024993  1 15 23:49 Tk-804.036.tar.gz
$ cd Tk-804.036	←☆ディレクトリに移動。
$ ll	←☆ディレクトリの中身。
total 2504
drwxr-xr-x@   7 asakunotomohiro  staff     224  2 14  2021 Contrib/
drwxr-xr-x@   5 asakunotomohiro  staff     160  2 14  2021 Entry/
　　　・
　　　・
　　　・
-rw-r--r--@   1 asakunotomohiro  staff    1084 11 16  2013 COPYING
-rw-r--r--@   1 asakunotomohiro  staff  213926 11 16  2013 Change.log
$ perl Makefile.PL	←☆Makefileの作成。
perlbrew/perls/perl-5.34.0/bin/perl is installed in perlbrew/perls/perl-5.34.0/lib/5.34.0/darwin-2level okay
PPM for perl5.034000
Test Compiling config/perlrx.c
Test Compiling config/pmop.c
　　　・
　　　・
　　　・
Finding dependencies for tkGlue_f.c
Finding dependencies for tkWin32Dll.c
Tests in PNG
Tests in JPEG
Tests in Event
Generating a Unix-style Makefile
Writing Makefile for Tk
Writing MYMETA.yml and MYMETA.json
$
$ make	←☆コンパイル。
cp Tk/Bitmap.pm blib/lib/Tk/Bitmap.pm
cp Tk/Photo.pm blib/lib/Tk/Photo.pm
　　　・
　　　・
　　　・
"perlbrew/perls/perl-5.34.0/bin/perl" -MExtUtils::MY -e 'MY->fixin(shift)' -- blib/script/ptksh
Manifying 2 pod documents
Manifying 5 pod documents
Sorry no HTML building yet
$ echo $?	←☆無事に終了では無いと思うが？
0
$
$ make test	←☆テスト実行。
"perlbrew/perls/perl-5.34.0/bin/perl" -MExtUtils::Command::MM -e 'cp_nonempty' -- Tk.bs blib/arch/auto/Tk/Tk.bs 644
cd pTk && make DEFINE="" LIBPERL_A="libperl.a" LINKTYPE="dynamic" OPTIMIZE="-O3" PREFIX="perlbrew/perls/perl-5.34.0" PASTHRU_DEFINE=' ' PASTHRU_INC='-I/usr/local/include '
Manifying 103 pod documents
Manifying 1 pod document
　　　・
　　　・
　　　・
MainWindow->new() at t/TkTest.pm line 41.
./xt/skip_all_mw.t .. skipped: Cannot create MainWindow (maybe no X11 server is running or DISPLAY is not set?)
Files=1, Tests=0,  0 wallclock secs ( 0.03 usr +  0.01 sys =  0.04 CPU)
Result: NOTESTS
$ echo $?
0
$
$ make install	←☆インストール実施。
cd pTk && make DEFINE="" LIBPERL_A="libperl.a" LINKTYPE="dynamic" OPTIMIZE="-O3" PREFIX="perlbrew/perls/perl-5.34.0" PASTHRU_DEFINE=' ' PASTHRU_INC='-I/usr/local/include '
Manifying 103 pod documents
Manifying 1 pod document
Manifying 2 pod documents
　　　・
　　　・
　　　・
Installing perlbrew/perls/perl-5.34.0/lib/site_perl/5.34.0/darwin-2level/Tk/demos/widget_lib/balloon.pl
Appending installation info to perlbrew/perls/perl-5.34.0/lib/5.34.0/darwin-2level/perllocal.pod
$ echo $?
0
$
$ perl -e 'use Tk'	←☆何もエラーは出なかった。
$
$ perl guiHelloworld.pl	←☆結局失敗している(Xサーバ未導入のため)。
Perl/TK開発でのハローワールド
couldn't connect to display ":0" at perlbrew/perls/perl-5.34.0/lib/site_perl/5.34.0/darwin-2level/Tk/MainWindow.pm line 53.
MainWindow->new() at guiHelloworld.pl line 12.
$
```
ちょいちょい警告が出ているのだが、気にしなくて良いのかな。  
事前に[Xサーバ](#x11clientinstall)が導入されていないのが原因だろう。  
Xサーバ導入後にTkをインストールするときは、GUI画面がちょいちょい起動した。  
そのため、起動させることが出来ずに警告が出たのだろう。  

</details>

1回目のCPANでのインストールは成功したのだが、2回目以降はCPANがうまく動いてくれなくなってしまった。  
何故だろうか。  
未だに解決できない。  


### Perl/TK用ディレクトリ削除。
アンインストールは、アンインストーラーがないため、手動でインストール先のディレクトリを消す必要がある。

<details><summary>手動削除。</summary>

以下、実施。
```terminal
$ rm -rf ./lib/site_perl/5.34.0/darwin-2level/auto/Tk
$ perl -e 'use Tk'
Can't locate loadable object for module Tk::Event in @INC (@INC contains: lib/site_perl/5.34.0 lib/5.34.0/darwin-2level ) at lib/site_perl/5.34.0/darwin-2level/Tk.pm line 13.
Compilation failed in require at lib/site_perl/5.34.0/darwin-2level/Tk.pm line 13.
BEGIN failed--compilation aborted at lib/site_perl/5.34.0/darwin-2level/Tk.pm line 13.
Compilation failed in require at -e line 1.
BEGIN failed--compilation aborted at -e line 1.
Undefined subroutine &Tk::Event::CleanupGlue called at lib/site_perl/5.34.0/darwin-2level/Tk/Event.pm line 3.
END failed--call queue aborted at -e line 1.
$ rm -rf ./lib/site_perl/5.34.0/darwin-2level/auto/Tk/pTk
$ rm -rf ./lib/site_perl/5.34.0/darwin-2level/Tk
$ rm -rf ./lib/site_perl/5.34.0/darwin-2level/Tk/pTk
$ find . -type d -name "*Tk*"
$
```

</details>


---
<a name="x11clientinstall"></a>
## Xサーバ(?)のインストール。
よく分かっていないが、上記の[Perl/TK開発](#guiProgramPerltkuse)に必要な道具。  

以下、インストール時に発生する大事なメッセージ。
```text
This is a community-supported version of the X11 windowing system for Mac OS X 10.9 or later.

Please visit http://www.xquartz.org for more information.
```
これは、GUI画面からのインストールになり、文字として記録に残せない。  


---
<a name="newuser"></a>
## 新機能の利用
まず初めに、バージョン指定の方法。  
ファイル行頭に記述するのは、前述通りだが、他にも方法がある。  
以下のどれかを記述すれば良い(すべて同じ意味)。
```Perl
use v5.24;
use 5.24.0;
use 5.024;
```
※v5.12以降の指定により、暗黙的に`strict`と`warnings`が有効になる。  
※この機能は、モジュール利用することを意味する。  
`use [モジュール名];`  


### [新機能のロード無し](https://perldoc.jp/func/require)
最小バージョンを指定する(どういう意味？)。
```Perl
require v5.24;
```


※この機能は、他のファイル内容を取り込むことを意味する。  
`require [ファイル名];`  


### [必要になったときに新機能をロードする](https://perldoc.jp/docs/modules/feature-1.20/feature.pod)。
書籍の説明が理解できないのだが、指定した新機能をロードする？
```Perl
use feature qw(:5.10);
```
※この書き方により、指定バージョンに関連するタグを暗黙のうちにロードするようだ。  


### 個別に新機能のロード実施。
全てではなく、個別にロードする(上記とは違うってことだよね)。
```Perl
use feature qw(state signatures);
```


### 新機能の無効。
`feature`プラグマにより無効化しているため、そのプラグマが使えるバージョンが最低でも必要になる。
```Perl
no feature qw(:all);
```
※要は、無効化するほど古いバージョンを使っていないのに、新しいのでは動かないという思い込みの強い人が使うバージョン指定だろう。  


ちなみに、本書の1章分の学習時間は1〜2時間ほどだそうだ(1週間で読了できるそうだ)。  
そして、[Perl6](https://raku.org)は、[Raku](https://docs.raku.org)に名前が変わっていると思って良いよね。  


以上。
<!-- vim: set ts=4 sts=4 sw=4 tw=0 ff=unix fenc=utf-8 ft=markdown expandtab: -->
